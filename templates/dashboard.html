{% extends 'base.html' %}
{% block content %}
<h2 class="text-center">ğŸ“‹ ä»»å‹™æ¸…å–®</h2>

<!-- æ–°å¢ä»»å‹™è¡¨å–® -->
<form method="post" class="row g-2 my-4">
    <div class="col-md-5">
        <input type="text" name="content" class="form-control" placeholder="è«‹è¼¸å…¥ä»»å‹™å…§å®¹">
    </div>
    <div class="col-md-4">
        <select name="category" class="form-select">
            <option value="">è«‹é¸æ“‡ä»»å‹™åˆ†é¡</option>
            <option value="å­¸ç¿’">å­¸ç¿’</option>
            <option value="å·¥ä½œ">å·¥ä½œ</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-success w-100">æ–°å¢ä»»å‹™</button>
    </div>
</form>

<!-- é¡¯ç¤ºä»»å‹™æ¸…å–® -->
<ul class="list-group mb-4">
{% for task in tasks %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            {% if task.is_done %}
                âœ… <s>{{ task.content }}</s>
            {% else %}
                â³ {{ task.content }}
            {% endif %}
            <small class="text-muted ms-2">[{{ task.category or 'æœªåˆ†é¡' }}]</small>
        </div>
        <a href="{{ url_for('complete', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">æ¨™è¨˜å®Œæˆ</a>
    </li>
{% endfor %}
</ul>

<!-- å®Œæˆä»»å‹™åœ“é¤…åœ– -->
<div style="width: 250px; height: 250px;" class="mx-auto mb-4">
    <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const completed = {{ completed|tojson }};
    const pending = {{ pending|tojson }};
    const total = completed + pending;
    const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

    const centerText = {
        id: 'centerText',
        beforeDraw(chart) {
            const { width, height } = chart;
            const ctx = chart.ctx;
            ctx.restore();
            const fontSize = 18;
            ctx.font = `${fontSize}px sans-serif`;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#333';
            ctx.fillText(`å®Œæˆç‡ ${percent}%`, width / 2, height / 2);
            ctx.save();
        }
    };

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['å·²å®Œæˆ', 'æœªå®Œæˆ'],
            datasets: [{
                data: [completed, pending],
                backgroundColor: ['#198754', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        },
        plugins: [centerText]
    });
</script>

<!-- ç™»å‡ºæŒ‰éˆ• -->
<div class="text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">ç™»å‡º</a>
</div>
{% endblock %}